name: warm-cache

on:
  workflow_dispatch:
  workflow_run:
    workflows: [migrations]
    types: [completed]
  push:
    paths:
    - 'migrations/warm-cache/**'
    - 'docker/warm-cache.Dockerfile'
    branches-ignore:
    - 'master'
    - 'develop'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  integration_test:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'push' || github.event.workflow_run.conclusion == 'success' }}
    name: test cache key consistency
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: us-east-1
    steps:
      - uses: actions/checkout@v4
      - name: mask values
        run: echo "::add-mask::${{ secrets.AWS_ACCOUNT_ID }}"
      - name: install psql
        run: |
          sudo install -d /usr/share/postgresql-common/pgdg
          sudo curl -o /usr/share/postgresql-common/pgdg/apt.postgresql.org.asc --fail https://www.postgresql.org/media/keys/ACCC4CF8.asc
          sudo sh -c 'echo "deb [signed-by=/usr/share/postgresql-common/pgdg/apt.postgresql.org.asc] https://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          sudo apt-get update
          sudo apt-get install --yes --no-install-recommends postgresql-client
      - name: start storage
        # starts postgres, redis, warm-cache (populates redis from local postgres)
        run: docker compose -f docker/storage.yaml --profile init up -d --build --wait
      - name: save redis keys
        # save redis keys populated by warm-cache in storage.yaml
        run: |
          docker exec mxf-redis-1 redis-cli -a test --no-auth-warning KEYS '*' | sort > /tmp/redis_keys.txt
          echo "redis key count: $(wc -l < /tmp/redis_keys.txt)"
      - name: reset rds
        # reset dev rds to match local postgres seed data
        run: ENV_ID=${{ secrets.DEV_ENV_ID }} make -C migrations/go-migrate resetrds
      - name: clear ddb cache
        run: |
          # temporarily add env vars to warm-cache get array so make env fetches them
          yq -i '.migrations.warm-cache.env_var.get += ["AWS_LAMBDA_FUNCTION_NAME", "CACHE_KEY_RULES_STATE", "CACHE_KEY_RULES_ACCOUNT", "CACHE_KEY_PROFILE", "CACHE_KEY_PROFILE_ID", "CACHE_KEY_APPROVERS"]' project.yaml
          # generate .env from project.yaml defaults and ssm
          ENV_ID=${{ secrets.DEV_ENV_ID }} make -C migrations/warm-cache env ENV=dev
          # export .env vars to current shell
          set -a && source migrations/warm-cache/.env && set +a
          # clear all items from ddb table
          aws dynamodb scan --table-name "$TRANSACTION_DDB_TABLE" --projection-expression "pk, sk" --output json \
            | jq -c '.Items[]' \
            | while read -r item; do
                aws dynamodb delete-item --table-name "$TRANSACTION_DDB_TABLE" --key "$item"
              done
          echo "ddb cache cleared"
      - name: warm ddb cache
        run: |
          # export .env vars to current shell
          set -a && source migrations/warm-cache/.env && set +a
          # run warm-cache.sh locally against dev rds, writes to dev ddb
          bash migrations/warm-cache/warm-cache.sh
      - name: fetch ddb keys
        # fetch keys written to dev ddb by warm-cache.sh
        run: |
          set -a && source migrations/warm-cache/.env && set +a
          aws dynamodb scan --table-name "$TRANSACTION_DDB_TABLE" --projection-expression "pk" --output json | jq -r '.Items[].pk.S' | sort -u > /tmp/ddb_keys.txt
          echo "ddb key count: $(wc -l < /tmp/ddb_keys.txt)"
      - name: reconcile keys
        # compare redis keys (from local) vs ddb keys (from dev)
        run: |
          echo "comparing redis vs ddb keys..."
          if ! diff /tmp/redis_keys.txt /tmp/ddb_keys.txt; then
            echo "key mismatch detected"
            echo "=== in redis but not ddb ==="
            comm -23 /tmp/redis_keys.txt /tmp/ddb_keys.txt
            echo "=== in ddb but not redis ==="
            comm -13 /tmp/redis_keys.txt /tmp/ddb_keys.txt
            exit 1
          fi
          echo "keys reconciled successfully"
      - name: clean up
        run: docker compose -f docker/storage.yaml down
  push_image:
    if: ${{ github.event_name == 'push' || github.event.workflow_run.conclusion == 'success' }}
    name: push image to dev ecr
    runs-on: ubuntu-latest
    needs: integration_test
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: us-east-1
      APP_DIR: migrations/warm-cache
    steps:
      - uses: actions/checkout@v4
      - name: mask values
        run: echo "::add-mask::${{ secrets.AWS_ACCOUNT_ID }}"
      - name: build image
        run: make -C $APP_DIR build-image
      - name: tag image
        run: ENV_ID=${{ secrets.DEV_ENV_ID }} make -C $APP_DIR tag-dev-image
      - name: push image
        run: ENV_ID=${{ secrets.DEV_ENV_ID }} make -C $APP_DIR push-dev-image